# Implementation Plan: Core Backend & API

**Branch**: `001-backend-api` | **Date**: 2026-02-08 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-backend-api/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Build a secure FastAPI backend with JWT authentication and RESTful task management endpoints. The API will enforce strict user isolation, verify JWT tokens on every request, and persist data to Neon Serverless PostgreSQL using SQLModel ORM. Development follows a layered approach: database models → authentication middleware → API routes → error handling.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI 0.104+, SQLModel 0.0.14+, PyJWT 2.8+, python-jose[cryptography] 3.3+, psycopg2-binary 2.9+, uvicorn[standard] 0.24+
**Storage**: Neon Serverless PostgreSQL (via connection string in environment variable)
**Testing**: pytest 7.4+, pytest-asyncio 0.21+, httpx 0.25+ (for FastAPI test client)
**Target Platform**: Linux server (Docker containerized, Python 3.11 base image)
**Project Type**: Web application (backend only - this spec covers API layer)
**Performance Goals**: <200ms p95 latency for all endpoints, <10ms JWT verification, 100+ concurrent requests
**Constraints**: JWT 7-day expiration, user isolation enforcement (401/404 responses), CORS enabled for frontend, environment-based configuration
**Scale/Scope**: Multi-user todo application, initial deployment supports 100+ concurrent users, 10k+ tasks per user

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Accuracy ✅
- **Requirement**: API endpoints MUST follow RESTful conventions (GET, POST, PUT, DELETE, PATCH)
- **Compliance**: All endpoints defined in spec follow REST standards with proper HTTP methods
- **Verification**: OpenAPI schema will document exact request/response formats

### Principle II: Security (NON-NEGOTIABLE) ✅
- **Requirement**: JWT tokens MUST be verified on every protected API request
- **Compliance**: Middleware will extract, verify, and decode JWT on all `/api/{user_id}/tasks` endpoints
- **Requirement**: All API endpoints MUST enforce task ownership validation
- **Compliance**: Every endpoint checks that JWT user_id matches URL user_id and task owner_id
- **Requirement**: Unauthorized access MUST return HTTP 401 status
- **Compliance**: Middleware returns 401 for missing/invalid/expired tokens
- **Requirement**: Shared secrets MUST be stored as environment variables (BETTER_AUTH_SECRET)
- **Compliance**: JWT secret loaded from `BETTER_AUTH_SECRET` environment variable
- **Requirement**: JWT token expiration MUST be set to 7 days
- **Compliance**: Token verification checks exp claim (issued by Better Auth with 7-day expiration)
- **Requirement**: No hardcoded secrets or tokens in source code
- **Compliance**: All secrets via environment variables, no hardcoded values

### Principle III: Reproducibility ✅
- **Requirement**: Complete setup instructions MUST be documented
- **Compliance**: quickstart.md will provide step-by-step setup guide
- **Requirement**: Environment variables MUST be clearly specified
- **Compliance**: .env.example file with all required variables documented
- **Requirement**: Database schema and migrations MUST be version-controlled
- **Compliance**: SQLModel models define schema, Alembic migrations tracked in git
- **Requirement**: Dependencies MUST be explicitly declared (requirements.txt)
- **Compliance**: requirements.txt with pinned versions for all dependencies
- **Requirement**: Project MUST be deployable on local or server environments
- **Compliance**: Docker support with docker-compose.yml for local development

### Principle IV: Clarity ✅
- **Requirement**: API endpoints MUST follow consistent naming conventions
- **Compliance**: All endpoints follow `/api/{user_id}/tasks` pattern
- **Requirement**: Code MUST be organized by feature/domain
- **Compliance**: Structure: models/, middleware/, routes/, schemas/
- **Requirement**: API contracts MUST be documented (request/response schemas)
- **Compliance**: OpenAPI schema auto-generated by FastAPI, documented in contracts/
- **Requirement**: Error messages MUST be descriptive and actionable
- **Compliance**: Custom exception handlers with detailed error responses

### Principle V: Usability ⚠️
- **Status**: Not applicable to backend API (frontend responsibility)
- **Note**: API provides clear error messages to support frontend usability

### Technology Stack Compliance ✅
- **Backend**: Python FastAPI ✓
- **ORM**: SQLModel ✓
- **Database**: Neon Serverless PostgreSQL ✓
- **Authentication**: Better Auth with JWT plugin (JWT verification only, auth handled by separate service) ✓

### API Standards Compliance ✅
- **Endpoint Pattern**: `/api/{user_id}/tasks` ✓
- **HTTP Methods**: GET, POST, PUT, DELETE, PATCH ✓
- **Authentication**: Bearer token in Authorization header ✓
- **Response Format**: JSON with consistent structure ✓
- **Error Responses**: Standard HTTP status codes (200, 201, 204, 401, 404, 422, 500) ✓

**GATE STATUS**: ✅ PASSED - All applicable constitution requirements met

## Project Structure

### Documentation (this feature)

```text
specs/001-backend-api/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
│   └── openapi.yaml     # OpenAPI 3.0 specification
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── __init__.py
│   │   ├── task.py          # Task SQLModel
│   │   └── user.py          # User reference model (not managed by this API)
│   ├── middleware/
│   │   ├── __init__.py
│   │   └── auth.py          # JWT verification middleware
│   ├── routes/
│   │   ├── __init__.py
│   │   └── tasks.py         # Task CRUD endpoints
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── task.py          # Pydantic request/response schemas
│   │   └── error.py         # Error response schemas
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py        # Environment configuration
│   │   ├── database.py      # Database connection and session management
│   │   └── security.py      # JWT utilities
│   ├── exceptions/
│   │   ├── __init__.py
│   │   └── handlers.py      # Custom exception handlers
│   └── main.py              # FastAPI application entry point
├── tests/
│   ├── conftest.py          # Pytest fixtures
│   ├── test_auth.py         # JWT authentication tests
│   ├── test_tasks_crud.py   # Task CRUD operation tests
│   └── test_user_isolation.py  # User isolation security tests
├── alembic/
│   ├── versions/            # Database migration files
│   └── env.py               # Alembic configuration
├── requirements.txt         # Python dependencies
├── .env.example             # Environment variable template
├── Dockerfile               # Docker container definition
├── docker-compose.yml       # Local development setup
└── README.md                # Backend setup instructions

frontend/
└── [Not part of this spec - handled separately]
```

**Structure Decision**: Web application structure selected (Option 2) because this is a full-stack project with separate frontend and backend. The backend/ directory contains the FastAPI application with clear separation of concerns:
- **models/**: SQLModel database models
- **middleware/**: JWT authentication middleware
- **routes/**: API endpoint handlers
- **schemas/**: Pydantic request/response validation
- **core/**: Configuration, database, and security utilities
- **exceptions/**: Custom error handling
- **tests/**: Comprehensive test suite organized by feature

## Complexity Tracking

> **No violations** - Constitution check passed without requiring complexity justification.
